ARG GOBEL_ADMIN_CLIENT_IMAGE_NAME=${GOBEL_ADMIN_CLIENT_IMAGE_NAME}
ARG GOBEL_ADMIN_CLIENT_IMAGE_TAG=${GOBEL_ADMIN_CLIENT_IMAGE_TAG}
ARG GOBEL_NGINX_IMAGE_NAME=${GOBEL_NGINX_IMAGE_NAME}
ARG GOBEL_NGINX_IMAGE_TAG=${GOBEL_NGINX_IMAGE_TAG}
ARG PLATFORM=${PLATFORM}

FROM --platform=${PLATFORM} ${GOBEL_ADMIN_CLIENT_IMAGE_NAME}:${GOBEL_ADMIN_CLIENT_IMAGE_TAG} as build-stage

ARG VUE_APP_API_ENDPOINT
ENV VUE_APP_API_ENDPOINT=${VUE_APP_API_ENDPOINT}

RUN npm run prod-build

FROM --platform=${PLATFORM} ${GOBEL_NGINX_IMAGE_NAME}:${GOBEL_NGINX_IMAGE_TAG}

ARG GOBEL_PATH_TO_SSL_CERTIFICATE=${GOBEL_PATH_TO_SSL_CERTIFICATE}
ARG GOBEL_PATH_TO_SSL_CERTIFICATE=${GOBEL_PATH_TO_SSL_CERTIFICATE_KEY}
ARG GOBEL_ADMIN_CLIENT_PATH_TO_DIST=${GOBEL_ADMIN_CLIENT_PATH_TO_DIST}
ARG GOBEL_NGINX_ADMIN_CLIENT_ACCESS_LOG_NAME=${GOBEL_NGINX_ADMIN_CLIENT_ACCESS_LOG_NAME}
ARG GOBEL_NGINX_ADMIN_CLIENT_ERROR_LOG_NAME=${GOBEL_NGINX_ADMIN_CLIENT_ERROR_LOG_NAME}
ARG GOBEL_NGINX_API_ACCESS_LOG_NAME=${GOBEL_NGINX_API_ACCESS_LOG_NAME}
ARG GOBEL_NGINX_API_ERROR_LOG_NAME=${GOBEL_NGINX_API_ERROR_LOG_NAME}
ARG GOBEL_NGINX_CLIENT_ACCESS_LOG_NAME=${GOBEL_NGINX_CLIENT_ACCESS_LOG_NAME}
ARG GOBEL_NGINX_CLIENT_ERROR_LOG_NAME=${GOBEL_NGINX_CLIENT_ERROR_LOG_NAME}

WORKDIR /var/www/html
COPY --from=build-stage ${GOBEL_ADMIN_CLIENT_PATH_TO_DIST} ./
# NOTE: If you want to template nginx.conf, it seems you have to run envsubst yourself 
COPY ./nginx.conf /etc/nginx/nginx.conf

RUN rm -rf /etc/nginx/conf.d/default.conf \
    && ln -sf /dev/stdout /var/log/nginx/${GOBEL_NGINX_ADMIN_CLIENT_ACCESS_LOG_NAME}.log \
    && ln -sf /dev/stderr /var/log/nginx/${GOBEL_NGINX_ADMIN_CLIENT_ERROR_LOG_NAME}.log \
    && ln -sf /dev/stdout /var/log/nginx/${GOBEL_NGINX_API_ACCESS_LOG_NAME}.log \
    && ln -sf /dev/stderr /var/log/nginx/${GOBEL_NGINX_API_ERROR_LOG_NAME}.log \
    && ln -sf /dev/stdout /var/log/nginx/${GOBEL_NGINX_CLIENT_ACCESS_LOG_NAME}.log \
    && ln -sf /dev/stderr /var/log/nginx/${GOBEL_NGINX_CLIENT_ERROR_LOG_NAME}.log